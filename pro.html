<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MapleSchema Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 14px; border-radius:10px; border:0;
      font-weight:800; cursor:pointer; text-decoration:none;
      background:#4a2d21; color:#fff;
    }
    .btn.secondary { background:#222; }
    .btn.qb { background:#2CA01C; }
    .box { padding:14px; border:1px solid rgba(0,0,0,0.12); border-radius:12px; background:rgba(255,255,255,0.65); }
    .muted { opacity:0.8; }
    code { background: rgba(0,0,0,0.06); padding: 2px 6px; border-radius: 6px; }
    pre { white-space: pre-wrap; }
  </style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
  // Firebase configuration (STAGING)
  const firebaseConfig = {
    apiKey: "AIzaSyB960RtycsSigsJ77KwYlRWlPBb4e1DU1s",
    authDomain: "mapleschema-staging.firebaseapp.com",
    projectId: "mapleschema-staging",
    storageBucket: "mapleschema-staging.firebasestorage.app",
    messagingSenderId: "851079947514",
    appId: "1:851079947514:web:809a28d25d24eef5f01543",
    measurementId: "G-FCNZJQVSHV"
  };

  // Init Firebase
  firebase.initializeApp(firebaseConfig);

  // Auth handle
  const auth = firebase.auth();

  // API base (staging)
  const API_BASE = "https://staging.api.mapleschema.com";
</script>
</head>

<body>
  <div id="site">
    <header>
      <div class="container header-inner">
        <a href="/index.html" class="logo-link">
          <div class="logo-wrapper">
            <img src="/images/mapleschema-pro-icon.png" class="logo" alt="MapleSchema Pro logo">
          </div>
        </a>
        <nav>
          <a href="/index.html">Home</a>
          <a href="/privacy.html">Privacy</a>
          <a href="/contact.html">Contact</a>
        </nav>
      </div>
    </header>

    <main class="container" style="margin-top:16px;">
      <h1>MapleSchema Pro</h1>
      <p class="muted">
        This page targets <strong>staging</strong> API endpoints for billing and testing.
      </p>

      <div class="box" style="margin-top:12px;">
        <div class="row">
          <button id="btnLogin" class="btn">Sign in with Google</button>
          <button id="btnLogout" class="btn secondary" disabled>Log out</button>
          <button id="btnBilling" class="btn" disabled>Billing (Manage / Subscribe)</button>
        </div>

        <div style="margin-top:12px;">
          <div><strong>Status:</strong> <span id="authStatus">Not signed in</span></div>
          <div class="muted" style="margin-top:6px;">
            API target: <code id="apiBase"></code>
          </div>
        </div>

        <div id="msg" class="muted" style="margin-top:12px;"></div>
        <pre id="debug" class="muted" style="margin-top:10px; display:none;"></pre>
      </div>

      <div class="box" style="margin-top:12px;">
        <h2 style="margin-top:0;">Tools</h2>
        <div class="row">
          <a class="btn secondary" href="/transform.html">Free CSV Convert</a>
          <a class="btn" href="/transactions-json.html">Canonical JSON</a>
          <a class="btn qb" href="/quickbooks.html">QuickBooks</a>
        </div>
        <p class="muted" style="margin-top:10px;">
          Paid tools will be blocked by the API unless your Firestore <code>tier</code> is <code>paid</code>.
          Billing will redirect you to Stripe Checkout / Portal.
        </p>
      </div>
    </main>

    <footer>
      © MapleSchema 2026 • Pro Hub
    </footer>
  </div>

  <script>
    // ====== CONFIG (ONLY TODO HERE) ======
    // Paste your Firebase web config from Firebase Console → Project settings → Web app.
    const firebaseConfig = {
      apiKey: "PASTE_ME",
      authDomain: "PASTE_ME",
      projectId: "PASTE_ME",
      appId: "PASTE_ME",
      // others optional: storageBucket, messagingSenderId
    };

    // Force staging API for now.
    const API_BASE = "https://staging.api.mapleschema.com";
    document.getElementById("apiBase").textContent = API_BASE;

    // ====== INIT ======
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    const elStatus = document.getElementById("authStatus");
    const elMsg = document.getElementById("msg");
    const elDebug = document.getElementById("debug");

    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnBilling = document.getElementById("btnBilling");

    function setMsg(s) {
      elMsg.textContent = s || "";
    }
    function setDebug(obj) {
      elDebug.style.display = "block";
      elDebug.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }
    function clearDebug() {
      elDebug.style.display = "none";
      elDebug.textContent = "";
    }

    auth.onAuthStateChanged((user) => {
      clearDebug();
      if (!user) {
        elStatus.textContent = "Not signed in";
        btnLogout.disabled = true;
        btnBilling.disabled = true;
        setMsg("");
        return;
      }
      elStatus.textContent = `Signed in as ${user.email}`;
      btnLogout.disabled = false;
      btnBilling.disabled = false;
      setMsg("Ready. Click Billing to manage or subscribe.");
    });

    btnLogin.addEventListener("click", async () => {
      setMsg("Opening Google login…");
      clearDebug();
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await auth.signInWithPopup(provider);
      } catch (e) {
        setMsg("Login failed.");
        setDebug({ error: String(e) });
      }
    });

    btnLogout.addEventListener("click", async () => {
      clearDebug();
      setMsg("Signing out…");
      await auth.signOut();
      setMsg("");
    });

    async function postWithAuth(path) {
      const user = auth.currentUser;
      if (!user) throw new Error("Not signed in");
      const token = await user.getIdToken();
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json",
        },
      });
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch (_) {}
      return { res, text, json };
    }

    btnBilling.addEventListener("click", async () => {
      clearDebug();
      setMsg("Opening billing…");
      try {
        // 1) Try portal first (manage/cancel)
        const portal = await postWithAuth("/v1/billing/portal");
        if (portal.res.ok && portal.json && portal.json.url) {
          window.location.href = portal.json.url;
          return;
        }

        // If portal failed because user has no Stripe customer yet, fall back to checkout.
        // Your backend uses 409 CONFLICT for "no billing customer exists".
        if (portal.res.status === 409) {
          setMsg("No billing profile yet. Redirecting to checkout…");
          const checkout = await postWithAuth("/v1/billing/checkout");
          if (checkout.res.ok && checkout.json && checkout.json.url) {
            window.location.href = checkout.json.url;
            return;
          }
          setMsg("Checkout failed.");
          setDebug({ status: checkout.res.status, body: checkout.json || checkout.text });
          return;
        }

        // Any other portal error
        setMsg("Billing portal failed.");
        setDebug({ status: portal.res.status, body: portal.json || portal.text });

      } catch (e) {
        setMsg("Billing failed.");
        setDebug({ error: String(e) });
      }
    });
  </script>
</body>
</html>
