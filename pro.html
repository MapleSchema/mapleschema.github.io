<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MapleSchema Pro — Structured JSON & QuickBooks Exports</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="MapleSchema Pro generates structured transaction JSON and QuickBooks-ready imports from raw banking data."
  />

  <link rel="stylesheet" href="/css/style.css" />

  <script>
    // TEMP: keep prod site pointing at staging while Stripe is in test mode.
    const FORCE_STAGING_BILLING = true;

    const isStaging =
      FORCE_STAGING_BILLING ||
      location.hostname.includes("localhost") ||
      location.hostname.includes("staging");

    window.MAPLE_FIREBASE_CONFIG = isStaging
      ? {
          apiKey: "AIzaSyB960RtycsSigsJ77KwYlRWlPBb4e1DU1s",
          authDomain: "mapleschema-staging.firebaseapp.com",
          projectId: "mapleschema-staging",
          appId: "1:851079947514:web:809a28d25d24eef5f01543",
        }
      : {
          apiKey: "AIzaSyBgeIGdlYuQfBSGofSSjGoqq8s6KWnPrAE",
          authDomain: "mapleschema-prod.firebaseapp.com",
          projectId: "mapleschema-prod",
          appId: "1:379867061540:web:cab36006b09975b78ca7b1",
        };

    window.MAPLE_API_BASE = isStaging
      ? "https://staging.api.mapleschema.com"
      : "https://api.mapleschema.com";

    // Quick visibility in console, early.
    console.log("[MS][env] FORCE_STAGING_BILLING=", FORCE_STAGING_BILLING);
    console.log("[MS][env] isStaging=", isStaging);
    console.log("[MS][env] MAPLE_API_BASE=", window.MAPLE_API_BASE);
    console.log("[MS][env] MAPLE_FIREBASE_CONFIG.projectId=", window.MAPLE_FIREBASE_CONFIG?.projectId);
  </script>

  <!-- Firebase SDKs (compat, because code uses firebase.auth()) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // Initialize Firebase once
    if (!window.firebase) {
      console.error("[MS][firebase] Firebase SDK failed to load.");
    } else if (!firebase.apps.length) {
      firebase.initializeApp(window.MAPLE_FIREBASE_CONFIG);
      console.log("[MS][firebase] initializeApp OK");
    } else {
      console.log("[MS][firebase] already initialized");
    }
  </script>

  <style>
    .box {
      padding: 16px;
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      background: rgba(255,255,255,0.65);
    }
    .btn {
      display: inline-flex;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 800;
      text-decoration: none;
      background: #4a2d21;
      color: #fff;
    }
    .btn.qb { background:#2CA01C; }
    .muted { opacity:0.85; }
    .toggleWrap { display:flex; gap:8px; margin-top:12px; }
    .toggleBtn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0.25);
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }
    pre {
      white-space: pre-wrap;
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255,255,255,0.55);
      overflow: auto;
      margin-top:12px;
    }

    /* Debug panel */
    .dbg {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.35;
      background: rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
    }
    .dbg .row { display:flex; gap:10px; padding: 2px 0; }
    .dbg .k { width: 210px; opacity: 0.85; }
    .dbg .v { flex: 1; word-break: break-word; }
    .dbg .actions { display:flex; gap:8px; margin-top: 10px; flex-wrap: wrap; }
    .dbg .btn2 {
      display:inline-flex;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.15);
      background: #fff;
      font-weight: 800;
      cursor:pointer;
    }
  </style>
</head>

<body>
<div id="site">

  <!-- HEADER -->
  <header>
    <div class="container header-inner">
      <a href="/index.html" class="logo-link">
        <img
          src="/images/mapleschema-transparent-pro-icon.png"
          class="logo"
          alt="MapleSchema Pro"
        />
      </a>
      <nav>
        <a href="/privacy.html">Privacy</a>
        <a href="/contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <main class="container" style="margin-top:20px;">

    <!-- HERO -->
    <section>
      <h1>MapleSchema Pro</h1>
      <p class="hero-lead">
        Upload bank data → Pick a format → Download instantly
      </p>
    </section>

    <!-- DEBUG PANEL -->
    <section style="margin-top:12px;">
      <article class="box">
        <h2 style="margin-top:0;">Debug</h2>
        <p class="muted" style="margin-top:6px;">
          This panel is temporary. It shows auth + environment + last request state.
        </p>

        <div class="dbg" id="dbgPanel">
          <div class="row"><div class="k">hostname</div><div class="v" id="dbgHost"></div></div>
          <div class="row"><div class="k">FORCE_STAGING_BILLING</div><div class="v" id="dbgForce"></div></div>
          <div class="row"><div class="k">MAPLE_API_BASE</div><div class="v" id="dbgApiBase"></div></div>
          <div class="row"><div class="k">firebase projectId</div><div class="v" id="dbgProject"></div></div>
          <div class="row"><div class="k">auth state</div><div class="v" id="dbgAuthState"></div></div>
          <div class="row"><div class="k">user email</div><div class="v" id="dbgEmail"></div></div>
          <div class="row"><div class="k">idToken length</div><div class="v" id="dbgTokenLen"></div></div>
          <div class="row"><div class="k">last request</div><div class="v" id="dbgLastReq"></div></div>
          <div class="row"><div class="k">last response</div><div class="v" id="dbgLastResp"></div></div>

          <div class="actions">
            <button class="btn2" id="btnDbgRefresh" type="button">Refresh debug</button>
            <button class="btn2" id="btnSignOut" type="button">Sign out</button>
          </div>
        </div>
      </article>
    </section>

    <!-- 1. FREE CSV CONVERTER (ENTRY POINT) -->
    <section style="margin-top:16px;">
      <article class="box" style="border-left:6px solid #2CA01C;">
        <h2>Free CSV Converter</h2>
        <p class="muted">
          Convert raw banking JSON into a clean, normalized CSV.
          Limited to <strong>200 transactions per request</strong>.
        </p>
        <a class="btn qb" href="/transform.html">
          Convert JSON → CSV
        </a>
      </article>
    </section>

    <!-- 2. PRO SUBSCRIPTION -->
    <section style="margin-top:12px;">
      <article class="box">
        <h2>MapleSchema Pro</h2>

        <p class="muted">
          MapleSchema Pro unlocks higher-volume exports and AI-enriched outputs for production workflows.
        </p>

        <ul class="muted" style="margin:10px 0 12px 18px;">
          <li><strong>Up to 1,000 transactions per request</strong> (free tier: 200)</li>
          <li><strong>Core CSV</strong> or CSV with optional <strong>AI-powered Insights</strong></li>
          <li><strong>Structured transaction JSON</strong> with AI Insights for workflows</li>
          <li><strong>QuickBooks-ready</strong> Expense and Payment import files</li>
        </ul>

        <p class="muted" style="margin-bottom:12px;">
          AI Insights are added as non-destructive annotations — core transaction data is never modified.
        </p>

        <a id="subscribeBtn" class="btn" href="#">
          Subscribe to MapleSchema Pro — $4 / month
        </a>
      </article>
    </section>

    <!-- 3. EXAMPLE OUTPUTS -->
    <section id="loggedOutExamples" style="margin-top:12px;">
      <article class="box">
        <h2 style="margin-top:0;">Example outputs</h2>
        <p class="muted" style="margin:6px 0 0 0;">
          Pro outputs: <strong>Structured CSV</strong>, <strong>Structured JSON</strong>, and <strong>QuickBooks Format</strong>.
        </p>

        <div class="toggleWrap" aria-label="Example output selector" style="margin-top:12px;">
          <button id="toggleCsv" type="button" class="toggleBtn" onclick="msSetOutput('csv')">Structured CSV</button>
          <button id="toggleJson" type="button" class="toggleBtn" onclick="msSetOutput('json')">Structured JSON</button>
          <button id="toggleQb" type="button" class="toggleBtn" onclick="msSetOutput('qb')" style="border:2px solid #2CA01C;">QuickBooks Format</button>
        </div>

        <!-- OUTPUT: Structured CSV (Name / Value) -->
        <div id="msOutCsv" style="margin-top:14px; display:none;">
          <h3 style="margin: 0 0 8px 0;">Structured CSV (Name → Value)</h3>
          <p class="muted" style="margin-top:8px;">
            Same fields as Structured JSON, shown as a simple Name/Value export.
          </p>

          <div style="
            display:grid;
            grid-template-columns: minmax(220px, 1fr) minmax(260px, 2fr);
            gap:0;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 12px;
            overflow:hidden;
            background: rgba(255,255,255,0.55);
          ">
            <div class="muted" style="padding:10px 12px; font-weight:900; border-bottom:1px solid rgba(0,0,0,0.08);">Name</div>
            <div class="muted" style="padding:10px 12px; font-weight:900; border-bottom:1px solid rgba(0,0,0,0.08);">Value</div>

            <div class="muted" style="padding:10px 12px; font-weight:900; border-bottom:1px solid rgba(0,0,0,0.08);">transaction_fingerprint</div>
            <div class="muted" style="padding:10px 12px; border-bottom:1px solid rgba(0,0,0,0.08);">ms_fp_9f1c2c7b0d2a</div>

            <div class="muted" style="padding:10px 12px; font-weight:900; border-bottom:1px solid rgba(0,0,0,0.08);">institution_code</div>
            <div class="muted" style="padding:10px 12px; border-bottom:1px solid rgba(0,0,0,0.08);">rbc_ca</div>

            <div class="muted" style="padding:10px 12px; font-weight:900; border-bottom:1px solid rgba(0,0,0,0.08);">amount_minor</div>
            <div class="muted" style="padding:10px 12px; border-bottom:1px solid rgba(0,0,0,0.08);">-724</div>

            <div class="muted" style="padding:10px 12px; font-weight:900; border-bottom:1px solid rgba(0,0,0,0.08);">currency</div>
            <div class="muted" style="padding:10px 12px; border-bottom:1px solid rgba(0,0,0,0.08);">CAD</div>

            <div class="muted" style="padding:10px 12px; font-weight:900; border-bottom:1px solid rgba(0,0,0,0.08);">direction</div>
            <div class="muted" style="padding:10px 12px; border-bottom:1px solid rgba(0,0,0,0.08);">debit</div>

            <div class="muted" style="padding:10px 12px; font-weight:900; border-bottom:1px solid rgba(0,0,0,0.08);">original_description</div>
            <div class="muted" style="padding:10px 12px; border-bottom:1px solid rgba(0,0,0,0.08);">TIM HORTONS #0059 / LONDON ON</div>

            <div class="muted" style="padding:10px 12px; font-weight:900; border-bottom:1px solid rgba(0,0,0,0.08);">posted_at_utc</div>
            <div class="muted" style="padding:10px 12px; border-bottom:1px solid rgba(0,0,0,0.08);">2026-01-14T19:22:11Z</div>

            <div class="muted" style="padding:10px 12px; font-weight:900;">aggregator_code</div>
            <div class="muted" style="padding:10px 12px;">flinks</div>
          </div>
        </div>

        <!-- OUTPUT: Structured JSON -->
        <div id="msOutJson" style="margin-top:14px;">
          <h3 style="margin: 0 0 8px 0;">Structured Transaction JSON</h3>
          <pre class="muted" style="margin-top:10px; border: 1px solid rgba(0,0,0,0.12); border-radius: 12px; padding: 12px; background: rgba(255,255,255,0.55); overflow:auto;">{ "schema_version": "transactions-v1.0", "transaction_fingerprint": "ms_fp_9f1c2c7b0d2a", "institution_code": "rbc_ca", "posted_at": "2026-01-14T19:22:11Z", "amount": { "amount_minor": -724, "currency": "CAD" } }</pre>
        </div>

        <!-- OUTPUT: QuickBooks Format -->
        <div id="msOutQb" style="margin-top:14px; display:none;">
          <h3 style="margin: 0 0 8px 0;">QuickBooks Format (Payment)</h3>
          <pre class="muted" style="margin-top:10px; border: 1px solid rgba(0,0,0,0.12); border-radius: 12px; padding: 12px; background: rgba(255,255,255,0.55); overflow:auto;">Date,Payee,Description,Amount,Reference,AccountRef
2026-01-14,Example Vendor,Payment — invoice settlement,724.00,PAYMENT-1842,Accounts Payable</pre>
        </div>
      </article>
    </section>

  </main>

  <footer>
    © MapleSchema 2026 • Pro
  </footer>
</div>

<script>
  // -------------------------
  // Debug panel helpers
  // -------------------------
  const dbg = (id) => document.getElementById(id);
  const setDbg = (id, val) => { const el = dbg(id); if (el) el.textContent = String(val ?? ""); };

  let lastTokenLen = "";
  let lastReq = "";
  let lastResp = "";

  function refreshDebug() {
    setDbg("dbgHost", location.hostname);
    setDbg("dbgForce", String(typeof FORCE_STAGING_BILLING !== "undefined" ? FORCE_STAGING_BILLING : ""));
    setDbg("dbgApiBase", window.MAPLE_API_BASE);
    try {
      setDbg("dbgProject", firebase?.app()?.options?.projectId || "(unknown)");
    } catch (_) {
      setDbg("dbgProject", "(firebase not ready)");
    }

    const user = firebase?.auth?.()?.currentUser || null;
    setDbg("dbgAuthState", user ? "signed-in" : "signed-out");
    setDbg("dbgEmail", user?.email || "");
    setDbg("dbgTokenLen", lastTokenLen || "");
    setDbg("dbgLastReq", lastReq || "");
    setDbg("dbgLastResp", lastResp || "");
  }

  document.getElementById("btnDbgRefresh")?.addEventListener("click", refreshDebug);
  document.getElementById("btnSignOut")?.addEventListener("click", async () => {
    try {
      await firebase.auth().signOut();
      console.log("[MS][auth] signed out");
      lastTokenLen = "";
      refreshDebug();
    } catch (e) {
      console.error("[MS][auth] signOut failed", e);
      alert("Sign out failed: " + (e?.message || e));
    }
  });

  // Keep debug panel updated on auth change
  firebase.auth().onAuthStateChanged((user) => {
    console.log("[MS][auth] state changed:", user ? user.email : "(signed out)");
    refreshDebug();
  });

  // -------------------------
  // Auth + Checkout
  // -------------------------
  async function ensureGoogleSignIn() {
    const auth = firebase.auth();
    let user = auth.currentUser;

    if (user) return user;

    console.log("[MS][auth] signInWithPopup starting...");
    const provider = new firebase.auth.GoogleAuthProvider();
    const result = await auth.signInWithPopup(provider);
    console.log("[MS][auth] signInWithPopup OK:", result?.user?.email);
    return result.user;
  }

  async function startCheckout() {
    try {
      console.log("[MS][checkout] startCheckout()");
      console.log("[MS][checkout] MAPLE_API_BASE =", window.MAPLE_API_BASE);

      // Ensure user exists
      const user = firebase.auth().currentUser || (await ensureGoogleSignIn());
      if (!user) throw new Error("Not signed in");

      // Ensure token exists
      const idToken = await user.getIdToken(true);
      if (!idToken || idToken.length < 50) throw new Error("Missing ID token");

      lastTokenLen = String(idToken.length);
      console.log("[MS][checkout] token_len =", idToken.length);
      console.log("[MS][checkout] token_prefix =", idToken.slice(0, 16) + "...");

      const url = `${window.MAPLE_API_BASE}/v1/billing/checkout`;
      lastReq = `POST ${url} (auth=Bearer <token>)`;
      refreshDebug();

      const resp = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${idToken}`,
          "Content-Type": "application/json"
        }
      });

      console.log("[MS][checkout] HTTP", resp.status);

      const text = await resp.text();
      lastResp = `HTTP ${resp.status}: ${text.slice(0, 300)}${text.length > 300 ? "…" : ""}`;
      refreshDebug();

      if (!resp.ok) {
        alert("Checkout failed.\n\n" + text);
        return;
      }

      const data = JSON.parse(text);
      console.log("[MS][checkout] response json:", data);

      if (!data?.url) {
        alert("Checkout failed: missing redirect URL.");
        return;
      }

      window.location.href = data.url;
    } catch (e) {
      console.error("[MS][checkout] exception:", e);
      lastResp = "EXCEPTION: " + (e?.message || e);
      refreshDebug();
      alert("Checkout failed.\n\n" + (e?.message || e));
    }
  }

  document.getElementById("subscribeBtn")?.addEventListener("click", (e) => {
    e.preventDefault();
    startCheckout();
  });

  // Initial paint
  document.addEventListener("DOMContentLoaded", refreshDebug);
</script>

<script>
  function msApplyToggleStyles(activeId) {
    const ids = ["toggleCsv", "toggleJson", "toggleQb"];
    ids.forEach((id) => {
      const b = document.getElementById(id);
      if (!b) return;

      const isActive = (id === activeId);

      b.style.background = "#ffffff";
      b.style.color = "#000000";
      b.style.border = (id === "toggleQb")
        ? "2px solid #2CA01C"
        : "2px solid rgba(0,0,0,0.25)";

      if (isActive) {
        if (id === "toggleQb") {
          b.style.background = "#2CA01C";
          b.style.border = "2px solid #2CA01C";
          b.style.color = "#ffffff";
        } else {
          b.style.background = "rgba(0,0,0,0.08)";
          b.style.border = "2px solid rgba(0,0,0,0.35)";
          b.style.color = "#000000";
        }
      }
    });
  }

  function msSetOutput(which) {
    const panes = {
      csv: document.getElementById("msOutCsv"),
      json: document.getElementById("msOutJson"),
      qb: document.getElementById("msOutQb"),
    };

    Object.keys(panes).forEach((k) => {
      if (panes[k]) panes[k].style.display = (k === which) ? "block" : "none";
    });

    if (which === "qb") return msApplyToggleStyles("toggleQb");
    if (which === "csv") return msApplyToggleStyles("toggleCsv");
    return msApplyToggleStyles("toggleJson");
  }

  msSetOutput("json");
</script>

</body>
</html>
